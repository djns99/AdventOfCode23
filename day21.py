def get_and_clear_start(lines):
    w, h = len(lines), len(lines[0])
    print(w, h)
    for x, l in enumerate(lines):
        for y, c in enumerate(l):
            if c == "S":
                lines[x] = lines[x][:y] + '.' + lines[x][y + 1:]
                return (x, y)


def do(lines, start, numsteps, startstep=0):
    q = [start]
    w, h = len(lines), len(lines[0])

    oddset = set()
    evenset = set()
    currset = oddset if startstep % 2 else evenset
    currset.add(start)

    for step in range(startstep, numsteps):
        newq = []
        currset = oddset if (step + 1) % 2 else evenset
        for x, y in q:
            for dirx, diry in [(1, 0), (-1, 0), (0, 1), (0, -1)]:
                newpos = x + dirx, y + diry
                newx, newy = newpos
                if 0 <= newx < w and 0 <= newy < h and lines[newx][newy] == '.':
                    if newpos not in currset:
                        newq.append(newpos)
                        currset.add(newpos)
        # print(newq)
        q = newq
        if not q:
            break

    return evenset, oddset

    # for x,y in evenset:
    #     if 0 <= x < w and 0 <= y < h:
    #         lines[x] = lines[x][:y] + 'O' + lines[x][y+1:]
    # print("\n".join(lines))


def part1(lines):
    start = get_and_clear_start(lines)
    print("Start", start)
    print(list(len(x) for x in do(lines, start, 64)))


def part2(lines):
    start = get_and_clear_start(lines)
    w, h = len(lines), len(lines[0])
    steps = 26501365
    #steps = 13
    target_parity = steps % 2

    initial = do(lines, start, steps)
    count_initial = len(initial[target_parity])
    print("Initial", count_initial)

    starts = [
        # Veritcals
        (w - 1, h // 2), (0, h // 2),
        # Horizontals
        (w // 2, h - 1), (w // 2, 0),
        # Diagonals
        (0, 0), (0, h - 1), (w - 1, 0), (w - 1, h - 1)]
    parity = []
    for start in starts:
        parity.append(start in initial[target_parity])

    print("Parity", parity)
    # Straight lines are odd parity
    # Diagonals are even parity

    # Assumes w == h
    assert w == h
    step_half = w // 2

    # The steps before we start the first tile
    straight_base = step_half + 1
    # The steps before we completely finish the last tile
    straight_final = (w - 1) + step_half
    # The number of full tiles
    num_straight_tiles = (steps - straight_base - straight_final) // w + 1
    num_straight_tiles = max(num_straight_tiles, 0)
    print("Straight config", steps, straight_base, straight_final)

    straight_match_initial = num_straight_tiles // 2
    straight_flip_initial = num_straight_tiles - straight_match_initial
    print("Match count", straight_match_initial, straight_flip_initial)
    count_straight = straight_match_initial * len(initial[parity[0]])
    count_straight += straight_flip_initial * len(initial[not parity[0]])

    count_straight *= 4  # 4 way symmetry
    print("Straight", count_straight)

    # Step half for first tile, num_straight * w for full straight tiles
    straight_final_tile_steps = max(steps - step_half - num_straight_tiles * w, 0)
    print("Straight final steps", straight_final_tile_steps)

    partial_straights = []
    for start in starts[:4]:
        print(steps, steps - straight_final_tile_steps)
        results = do(lines, start, steps, steps - straight_final_tile_steps + 1)
        partial_straights.append(len(results[target_parity]))

    print("Partial straight", partial_straights)

    diagonal_base = (step_half + 1) * 2  # Half up, Half across, +1 to go into the next tile
    diagonal_final = (w - 1) * 2  # Up then across
    height_diagonal = (steps - diagonal_base - diagonal_final) // w + 1
    height_diagonal = max(height_diagonal, 0)
    print(steps, diagonal_base, diagonal_final, w)
    diagonal_match_initial = sum(range(1, height_diagonal+1, 2))
    diagonal_flip_initial = sum(range(0, height_diagonal+1, 2))
    print("Num diagonal", diagonal_match_initial, diagonal_flip_initial)

    count_diagonal = diagonal_match_initial * len(initial[not parity[4]])
    count_diagonal += diagonal_flip_initial * len(initial[parity[4]])

    count_diagonal *= 4
    print("Diagonal", count_diagonal)

    #  There are two diagonals of partial tiles
    #  O
    #  IO
    #  .IO
    #  ..IO
    diagonal_final_tile_steps_inner = max(steps - (step_half * 2 + 1) - height_diagonal * w, 0)
    # Extra factor of w
    diagonal_final_tile_steps_outer = max(diagonal_final_tile_steps_inner - w, 0)
    print("Diagonal inner", diagonal_final_tile_steps_inner)
    print("Diagonal outer", diagonal_final_tile_steps_outer)

    num_inner = height_diagonal + 1
    num_outer = height_diagonal + 2

    partial_diagonals = []
    for start in starts[4:]:
        for extrasteps, count in (diagonal_final_tile_steps_inner, num_inner), (
                diagonal_final_tile_steps_outer, num_outer):
            results = do(lines, start, steps, steps - extrasteps + 1)
            partial_diagonals.append(len(results[target_parity]) * count)

    print("Partial diagonal", partial_diagonals)

    result = count_initial + count_straight + sum(partial_straights) + count_diagonal + sum(partial_diagonals)
    print("Result", result)


def main(input):
    part1(input.strip().split('\n'))
    part2(input.strip().split('\n'))


input = """
...
.S.
...
"""
main(input)

input = """
...........
.....###.#.
.###.##..#.
..#.#...#..
....#.#....
.##..S####.
.##..#...#.
.......##..
.##.#.####.
.##..##.##.
...........
"""
#main(input)

input = """
...................................................................................................................................
.#..#..#.....#....#.#..#.......#...............#...........#...................##...........#.........#............#.#....#....#...
...##.#..#.....#.......#.......#....................#..#.......................#.....#.#...#.......................##.#....#.#.....
..#.........................#.........#...##.....##..#...#...................#.............#.....#.........##........#.............
....#.#...#.............#...........#........#...#..#....#................#....#....#........#............#........#...............
..#.......##........#...#........#..#.......................................#....#......................#...#..#....#.#..........#.
......#.#....#...................#......#.....##.......#..........#..........#..#.............#...#...#.#..#..#.#..#...#......#.##.
.#...........#.............##...#...##.#............................#.......#...##.....#...#..#......#.............................
........#...#.............#...#.....##..#......................##.................#..#..##..#.........#.........#............#.....
....#..#.##.#...#......#...#..............#...##.#..#..........#...............##..........#......#........##.#....#.....#.........
....#..#.....##....#.......................#.......#..............#..............#..#..#.............#........#...#..##............
...#.......#....#....#...#.#...#.#..........#...#..........#....#........................##..........#...#...#...#.................
...#.#.....#.........#....#.....##..............#....................####.............................#....#......##...#.....#.....
.#..#......................#..............#.............#.#...###.#.##....#...................#.......#.....##......#..........#...
..........#.#.#...........###............................#......................................#.........#..#..#........#.......#.
............#.......#....................................#...........#.#.............#...........#.#..#...#...#.........#..........
..........#.............#.....#....#.#.....#...................#....#.................#..........#............#.......##.......#...
...##........#...#..#......#.........................##.............##.###............#..........#........#..#...#...#.............
...........##......#.#....###.............#...............#.......#...#................#................#.#......#.....##....#.....
..............#.....................................#.............#......###..#...........#............#.#.....#...........#...#...
.................................#......................#.............#.....................#......#...##...........#......#..#..#.
.......#..#..................#.....#..............#...##.#.#.........#.........#..#...........#..........#.....#....#...##.......#.
.....#.#....#.#....................#..................#...............#..#...................#...#.......##....##......#..#.....#..
.........#.....#...#..........##.#.#...............#..........#...#..........#.....................#..............#..#.............
.......#..........#...#.....#...#....#....................#...##.......#...#..........................#.......#.......#..#..#......
........#.##........#.......#...................###..#......#...................##.......................#.........#....#..........
...........#........#............................#.........#...#..###.#......#..#.###...........#.#..#.................#..#..###...
...........#....#..#....#.................#........#..#.#....###.....#....#...#....#..#...........#...........#...#....#.#......#..
..#..#.#..#....#.###.##...#......................#.......#.....#......................#...........#.....#.#........#...........#...
..............#...........##.#.............#....#...#....#...##......##.....#........##...........#............##.#....###.........
..#..................##...#.................#.........................#..#..........#.#.#..........#....##..............#......##..
.....#..#.##......#....................#..#............#..#............##..#..............................#.#..#.....#...........#.
...###....#.....#....#....#......................##.....#..#......#..##........#.............................#.....##..............
...#..........#..#.#..#..........................#....#........#..............................................#..##...........#....
........##...#......###..#..................####..#.#...#...#......#...##....#.....#........................#.....#................
......##...........#......................#.##.#........#...........#...#......#...#..#.................#.#.......#...#..........#.
...#..........#........##.............#.............#........#.....#........#............##.....#.........#..##.#.....#......#.#...
.#..........#.#.........#..........#....................#..#....#...................#...#.....#...........#............##.....#....
................#......#........#..............#.##.......#...#....#..........#....#.....#.....#............#..#...#..##.....#..#..
...##....#..........#................##......#........##......................#.#...#.......##..#.#.#.........#.......###..........
...###.......................###.#..............#...#...#.......#.........###.....##.................#.......#....#........##..##..
............#...#...........#..#............#.......##..........................#....#...#.....#..............###........#.........
.......#.##......#.............#...#...................#....#.........#...........###......#......................#................
....###........#.#........#.#.#.....#..#........##..#.......#.#...................#.....#.#.....##....#.................#.#..#.....
.##....#..................#........#..#.........#...........................#.............#........#..#................##...#....#.
.#...........................#.............#.#.....#.#..#...............#........##...............................##....#.#........
.#.#..#....................#...............##....#.....#..............#.....................#......##..............................
..#........#.#..........#.........##....................#.........#......##..###...........#...#.....##..#..........#......###.....
......#...............#...#...#.##......##..#..#.....#...#.##.#...............#..............#...#......#.#..#..................##.
............#..........#..#.##...#.#.....#..........#..#..........#..#......##..............#......##.....................#.#.#....
...#..##.#................##.#...#...........#...........................#...#..#.#.#............#.##........##....................
....#........................................#....#..##..............#.........#..#...#......#..........#.......#........#....#....
....................#..........#.............#...........#...............#......##.......##..#.........#.......#.........#.#.......
..#.............#...##..#......................#.......#.#.#.#..#..#..#.#....#.....#..#.......#..#.........#....#..................
..#..................................#.....................#......#.#.#............#.....#..#..##....###...#.......................
...#............#...#...#.#.......#...###............................#..#................#..........#..........#................##.
....#...................#...##......#......#...........................#.#...##...........#......#..#...........#..............#...
.#............#............#.....................##...........#.......................#........................#...............#...
...........#.......#..##.##..#......#.......#.......#.....#..............................#.......#.#...#.....#.#.....#.............
..........#....#.......#...#....##.#.......#.......................#.#......#.#.........##......................#..................
..............#.................#..#.#..#.#.........##..#....#....#...#..........#.....#.#..#.....................#..#.#.........#.
..................#.....................#..###.#....#.#.............#..##..#.#.##.#.............#.#..#......#.#..##..##.##.........
.............#.....#....#..........#........#.....#.....##..###..........#.......#.#.....................#....#...#...##...........
......#............#....#.#..#..#......##..........#.#.......#...........#.#....#.....#...#...........#...#.......#.......#........
......................#....................#......#............#...#.......#.......#.#.#.#.........#......#......#..#..............
.................................................................S.................................................................
........#.....#...#..................#..#..............##....###..............#.#...........#...#.#.#.#.#........#.#.#...#...#.....
.........#...........#............#.##...#...#..........#.....#..............#...#......##..#..#.......#..#.#.##.....#..#..........
.......#.........#.#..................#...#........................#..............#...........#.#.#.........#.............#........
............####..........#..........#........#....#.....#...........#...........#..##..#..................#...#......#............
...............................#..##......#....#.#......................#........#.#..#.#..............#.....#.#...................
..........#.#...#...##.............#..#..#....#.......#..##.........##...##......#.........#...#...##........#.##..#...............
.................#..............#......#...#...#..##..........#..........#...#....#.................#......###.#..##.#..........#..
....#........#...#........#.....#..#...#...##........#.....#................#.....#.#.....#......................#...#..........##.
...##...........#........#................#..##.....#...#.#...#....................#...........#.....#...............#..........#..
...#..............##...............................#.....#...........#...###............#....#............#.#.#....##..............
...#...........##...#......#......####..##......#....#......#..##...#..#...........##..................#...##.#.#..#..........#....
..........................#....#....#..##.......#.............#...#..###..#..#.....................###....#...............#...##...
.......##........#...#....##...........#......#..............##.....##.....#..#.#...#.....#...........##.........................#.
...#..............##.#..#.#.........................................#....#............#....#.........#.............................
..#....................#..........#.....#...#.........#.....#..............#.....#.....#......#...#.#.....###.#.............#......
.......##..#...........#........##......#...#..##.....................#.#...#...#........#...............................#....#....
......#...#.....................#..................#.........#......#..#....#..###..#.............#.....#.................#..#.#...
.#....#.#.............#......#.........#...#.............#...#...........#....#..........#......#.#..#..................#........#.
....#...#.................#....#..#...#.......#..#...#.........#..#.#.#.......#....#...#...............#...#..................#..#.
.......................................#........#..#....#...#.......#.....#...#..#..............#.#...#..#.........#..##..#....#...
...##...#.................#.#.#..#.....#..##....#..#...................#..................#..#.#...#..................#.......#....
....#....#.#...#.....................#...........#......#...#................#................#.........#..........#.#...........#.
...#..##...#...##.##..........#.......#..#...#..........#.#.......#.#.........#.#.......#..#........#.#.........##.#.....#..#......
...................#.................#.#.#...#...#.#.##.....#.........#......#.#...#..............#.............#.............#....
..#...#............#...........#....##........#.......#.......#.......#......................................#....#..............#.
....................##...............#.#................#..........#...#.............##...#..#................#.......#.#...#......
.#.............#........................#.......#....#..#.#..........#..#.......................#..................#.#....#...#.##.
...#....#...............#........#....##.........#.........#........#....#.......##.......#..#...............#................###..
.#......#.#....#..#.#.#..............#..............#..........#.........................#...#..................#...#.........#.#..
..#...........#...#.......................#........#.......#........#.#....#.............#...#............#.......#......#.##...#..
..#....#...........#.............................#.....#..#.#...#.................#..#........#............#..##.......#.....#.....
.#.......#........#...#.....#........#.......#.....#.....#........#.........#...#...........#.#.........#.#........##.......#......
...#.....#...#.............##............................................#...#........#....#.........##..........#.###.#.#.....#...
.#...#..#.......................................#...........#.......#.##..#.....##......#.............#...#...#.#........#.........
..................#..........##.........#...........#..#.......#........#.#..........#....#............#..............#.#....#.....
..#.........#...........#.#...............#.#.....###......#.#....#...........#..........................#..................#......
.##.#......#...#...#..........#...........#........#.......#.#.....#..#.....#..#......##.........#.#...#...#..........#.....#......
...........##....#...#.....#.#.#...........#...#..#.......#............#..#....#.......................#....#..#..#.....##...#.#...
.#...##...#.........##.......#.##.#...........#......#.....#..........#...#...##......#..................#..#.............#........
............#.#..#.......#...##..#............#.......#...#.#..............#....#....#...................#.##..#......#.........#..
........##.#..#....#.#.#............................#.#..............##........#.#.................#.....#..#.#.....#..............
...#.........#..........#.#...................#.................#.##................#.........#..#...#.#..#.#.#..............#.....
...#.........##......##...#..........................#......#.......#......................................#.##..#..#........##....
.....#.#....#...#....#.#..#...##.......#..........#....#.....#........#........##.#...............#...#....#...#........#.......#..
.##....................................................#..#..............#....................#..#..#..###.....#..##......#....#...
..#..#.....#.#........#.........#.#........................##..#...............#........#..#..#......#...#...#.....................
.....#....##......#...#..........#.................#............#.#.........#............#........#........#.#...#...#.............
............##.#.....................................#......#........#.##.#....................#.......#.....#.....##...........##.
...#.........#.....#...#..............#....#.#..........#....##.........#.#..#............#.......................##..#.......#....
.#..#.........#.........##..#.##..............#............#....#..........#.........#...##.....#.....#.#....#.........#...........
..............#..#...#...##........#...#.#....#..............#..#...#.#............#...........#..........#...........##.#.........
....#....#........##.........#........#..#.#.#.............#.#....##.#.#...........#.........#..#...###.....#..#...#............#..
..........#...........#........##.#......................#..........#................#..............#............##.....#..........
...........#.....#............#.##.......#........................#...##........#.#....##....#.#...............#...#......#......#.
...#.....#..............#....#..#....#......#.....................#....#...................#...#.......##...#.......#.......#....#.
.#........#.......###........##.#.........##........#..............#..........##...#.......#.#.........#..#..#.#...##.....#....##..
..#....#.......#..#.....#...............#.#....#................#..#...................#...#.............#....#.....#..#.....#.....
......#.##.#..#.#......#.............#................#.......#..........................#.......#....#...#.#..#...#......#.#......
...#.....#..##.#.....#.#..............##....#....##...#...........................#..................#......#...#.....#.#.##.......
.#...#..............#...#..#....#.#..............#.#..............................###.....#.....#.......#.....#....#...............
..#...#.....#...#.#..##...#...##......#.#............#........................#..........#....#............................#.......
...........#..##........#..#.......#.......#......#............................##..#..#..#....#....#...........##..##..##.....#....
........#.#.#.........#...........#....#..#...#..#.......#..............#.....#.#................#..........#.#.#........####...#..
...#...#.#.#....#............#.......#.......#....#.....#......................#...#....#..........#..........#.#.......#...#...#..
...................................................................................................................................
"""
main(input)
